<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Public Display | Smart Campus</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            --accent-glow: #3b82f6;
            --text-white: #ffffff;
            --glass-panel: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-gradient);
            color: var(--text-white);
            height: 100vh;
            overflow: hidden;
            display: grid;
            grid-template-rows: 1fr 60px;
            /* Content, Ticker */
        }

        /* --- Main Layout: Split Screen --- */
        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            height: 100%;
        }

        /* Left Sidebar: Info Panel */
        .sidebar {
            background: rgba(0, 0, 0, 0.2);
            border-right: 1px solid var(--glass-border);
            padding: 2rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            backdrop-filter: blur(10px);
        }

        .brand-section {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .brand-logo {
            font-size: 2.5rem;
            color: var(--accent-glow);
        }

        .brand-text h2 {
            font-weight: 800;
            line-height: 1;
            letter-spacing: -0.5px;
        }

        .brand-text span {
            font-weight: 300;
            opacity: 0.7;
            font-size: 0.9rem;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        /* Dynamic Widget: Clock & Date */
        .widget-card {
            background: var(--glass-panel);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .clock-time {
            font-size: 3.5rem;
            font-weight: 800;
            line-height: 1;
            margin-bottom: 0.5rem;
            font-variant-numeric: tabular-nums;
        }

        .clock-date {
            font-size: 1.2rem;
            opacity: 0.8;
            font-weight: 300;
            text-transform: uppercase;
        }

        .weather-widget {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .weather-icon {
            font-size: 2.5rem;
        }

        .weather-temp {
            font-size: 2rem;
            font-weight: 600;
        }

        .weather-desc {
            font-size: 0.9rem;
            opacity: 0.7;
        }

        /* Right Side: Rotating Content */
        .display-area {
            position: relative;
            padding: 4rem;
            display: flex;
            align-items: center;
            justify-content: center;
            /* Animated Background Mesh */
            background-image:
                radial-gradient(circle at 80% 20%, rgba(59, 130, 246, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 20% 80%, rgba(139, 92, 246, 0.15) 0%, transparent 40%);
        }

        .slide {
            position: absolute;
            width: 80%;
            opacity: 0;
            transform: translateY(30px) scale(0.95);
            transition: all 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
            text-align: center;
        }

        .slide.active {
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        .tag-pill {
            display: inline-block;
            padding: 0.6rem 2rem;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 2rem;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
        }

        .tag-pill.urgent {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .tag-pill.event {
            background: linear-gradient(135deg, #8b5cf6, #6d28d9);
        }

        .tag-pill.notice {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .tag-pill.info {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .slide h1 {
            font-size: 4rem;
            font-weight: 800;
            line-height: 1.1;
            margin-bottom: 2rem;
            text-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .slide-meta {
            font-size: 1.8rem;
            opacity: 0.9;
            margin-bottom: 2rem;
            display: flex;
            justify-content: center;
            gap: 3rem;
        }

        .slide-desc {
            font-size: 1.5rem;
            opacity: 0.8;
            line-height: 1.6;
            max-width: 900px;
            margin: 0 auto;
            border-left: 4px solid rgba(255, 255, 255, 0.2);
            padding-left: 2rem;
        }

        /* --- Ticker --- */
        .ticker-bar {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            overflow: hidden;
            position: relative;
        }

        .ticker-label {
            background: #ef4444;
            color: white;
            padding: 0 2rem;
            height: 100%;
            display: flex;
            align-items: center;
            font-weight: 800;
            letter-spacing: 1px;
            z-index: 10;
        }

        .ticker-content {
            display: flex;
            animation: marquee 30s linear infinite;
            white-space: nowrap;
            padding-left: 100%;
        }

        .ticker-item {
            font-size: 1.2rem;
            margin-right: 4rem;
            opacity: 0.9;
        }

        @keyframes marquee {
            0% {
                transform: translateX(0);
            }

            100% {
                transform: translateX(-100%);
            }
        }

        /* Controls */
        .control-corner {
            position: fixed;
            top: 2rem;
            right: 2rem;
            display: flex;
            gap: 1rem;
            z-index: 100;
        }

        .btn-icon {
            color: rgba(255, 255, 255, 0.3);
            transition: 0.3s;
            cursor: pointer;
        }

        .btn-icon:hover {
            color: white;
        }
    </style>
</head>

<body>

    <div class="main-content">
        <!-- Sidebar -->
        <div class="sidebar">
            <div>
                <div class="brand-section">
                    <i class="fa-solid fa-layer-group brand-logo"></i>
                    <div class="brand-text">
                        <h2>SMART<br>CAMPUS</h2>
                        <span>Digital Notice Board</span>
                    </div>
                </div>

                <!-- Clock / Date Widget -->
                <div class="widget-card">
                    <div class="clock-time" id="clock-time">00:00</div>
                    <div class="clock-date" id="clock-date">Monday, Jan 01</div>
                </div>

                <!-- Weather Widget -->
                <div class="widget-card">
                    <div
                        style="font-size:0.8rem; text-transform:uppercase; letter-spacing:1px; margin-bottom:0.5rem; opacity:0.6;">
                        Campus Weather</div>
                    <div class="weather-widget" id="weather-box">
                        <i class="fa-solid fa-cloud-sun weather-icon"></i>
                        <div>
                            <div class="weather-temp" id="temp-display">--°C</div>
                            <div class="weather-desc" id="weather-desc">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Progress Indicator -->
            <div style="margin-top:auto;">
                <div
                    style="display:flex; justify-content:space-between; margin-bottom:0.5rem; font-size:0.8rem; opacity:0.5;">
                    <span>Next Update</span>
                    <span id="timer-display">7s</span>
                </div>
                <div style="height:4px; background:rgba(255,255,255,0.1); border-radius:2px; overflow:hidden;">
                    <div id="progress-bar" style="height:100%; background:var(--accent-glow); width:0%;"></div>
                </div>
            </div>
        </div>

        <!-- Display Area -->
        <div class="display-area" id="slide-container">
            <!-- JS Populated -->
        </div>
    </div>

    <!-- Ticker -->
    <div class="ticker-bar">
        <div class="ticker-label">ALERTS</div>
        <div class="ticker-content" id="ticker-content">
            <!-- JS Populated -->
        </div>
    </div>

    <!-- Controls -->
    <div class="control-corner">
        <a href="../index.html" class="btn-icon"><i class="fa-solid fa-right-from-bracket fa-xl"></i></a>
    </div>


    <script src="../assets/js/data.js"></script>
    <script>
        // Listen for Firebase Updates
        window.addEventListener('data-updated', () => {
            loadContent();
        });

        // --- 1. Clock & Date ---
        function updateTime() {
            const now = new Date();
            // Time
            document.getElementById('clock-time').textContent = now.toLocaleTimeString('en-US', {
                hour: '2-digit', minute: '2-digit', hour12: false
            });
            // Date
            document.getElementById('clock-date').textContent = now.toLocaleDateString('en-US', {
                weekday: 'long', month: 'short', day: 'numeric', year: 'numeric'
            });
        }
        setInterval(updateTime, 1000);
        updateTime();

        // --- 2. Weather (Mock API for Demo) ---
        async function fetchWeather() {
            try {
                // Using Open-Meteo (Free, No Key) - Defaulting to London coordinates for demo
                const res = await
                    fetch('https://api.open-meteo.com/v1/forecast?latitude=51.51&longitude=-0.13&current_weather=true');
                const data = await res.json();

                const temp = Math.round(data.current_weather.temperature);
                document.getElementById('temp-display').textContent = `${temp}°C`;

                const code = data.current_weather.weathercode;
                const descMap = { 0: "Clear Sky", 1: "Mainly Clear", 2: "Partly Cloudy", 3: "Overcast", 45: "Fog", 61: "Rain" };
                document.getElementById('weather-desc').textContent = descMap[code] || "Variable";

            } catch (e) {
                console.log("Weather Error", e);
                document.getElementById('temp-display').textContent = "24°C"; // Fallback
                document.getElementById('weather-desc').textContent = "Sunny (Demo)";
            }
        }
        fetchWeather();
        setInterval(fetchWeather, 600000); // 10 mins

        // --- 3. Slideshow Logic ---
        const SLIDE_DURATION = 7000;
        let slides = [];
        let currentIdx = 0;
        let slideTimer;
        let progressTimer;
        function loadContent() {
            if (typeof DataManager === 'undefined') {
                console.warn('DataManager not ready');
                return;
            }
            try {
                const notices = DataManager.getNotices() || [];
                const events = DataManager.getEvents() || [];
                slides = [];

                // Urgent Notices
                notices.filter(n => n.urgent).forEach(n => slides.push({
                    type: 'urgent', title: n.title, desc: n.desc, meta: n.department
                }));

                // Next 3 Events
                events.slice(0, 3).forEach(e => slides.push({
                    type: 'event', title: e.title, desc: `<i class="fa-solid fa-location-dot"></i> ${e.venue}`, meta:
                        `${DataManager.formatDate(e.date)} • ${DataManager.formatTime(e.time)}`
                }));

                // Recent Notices
                notices.filter(n => !n.urgent).slice(0, 3).forEach(n => slides.push({
                    type: 'notice', title: n.title, desc: n.desc, meta: n.department
                }));

                // Fallback
                if (slides.length === 0) slides.push({
                    type: 'info', title: 'Welcome to Campus', desc: 'No active updates.', meta:
                        'System'
                });

                // Ticker
                // Ticker
                const tickerHtml = notices.filter(n => n.urgent).map(n => `<span class="ticker-item">⚠️ ${n.title}</span>`).join('');
                document.getElementById('ticker-content').innerHTML = tickerHtml || '<span class="ticker-item">Welcome to Smart Campus Digital Display System</span>';

                currentIdx = 0; // Reset index on reload
                renderSlide(0);
                startTimer();
            } catch (e) {
                console.error("Error loading display content:", e);
                // Fallback to simple message
                slides = [{ type: 'info', title: 'System Maintenance', desc: 'Display is updating...', meta: 'System' }];
                renderSlide(0);
            }
        }

        function renderSlide(idx) {
            const container = document.getElementById('slide-container');
            if (!container) return; // Guard

            // Safety check for empty slides (async load timing)
            if (!slides || slides.length === 0) return;

            const s = slides[idx];

            // Note: 'active' class might have its own transition, but we add animate-entry for entry effect
            container.innerHTML = `
    <div class="slide active">
        <span class="tag-pill ${s.type} animate-entry">${s.type}</span>
        <h1 class="animate-entry delay-100">${s.title}</h1>
        <div class="slide-meta animate-entry delay-200">${s.meta.toUpperCase()}</div>
        <div class="slide-desc animate-entry delay-300">${s.desc}</div>
    </div>
    `;
        }

        function startTimer() {
            clearInterval(slideTimer);
            clearInterval(progressTimer);

            // Wait for slides if empty
            if (slides.length === 0) return;

            let startTime = Date.now();

            slideTimer = setInterval(() => {
                currentIdx = (currentIdx + 1) % slides.length;
                renderSlide(currentIdx);
                startTime = Date.now();
            }, SLIDE_DURATION);

            // Progress Bar
            const bar = document.getElementById('progress-bar');
            const timerText = document.getElementById('timer-display');

            progressTimer = setInterval(() => {
                const elapsed = Date.now() - startTime;
                const pct = Math.min((elapsed / SLIDE_DURATION) * 100, 100);
                const left = Math.ceil((SLIDE_DURATION - elapsed) / 1000);

                if (bar) bar.style.width = pct + '%';
                if (timerText) timerText.textContent = `${left}s`;
            }, 50);
        }

        // Initial load (wait slightly for data init if needed, or rely on event)
        // Since we are in a module now, DataManager is imported but maybe not populated
        // We'll call loadContent, which handles empty arrays gracefully
        loadContent();

    </script>
</body>

</html>